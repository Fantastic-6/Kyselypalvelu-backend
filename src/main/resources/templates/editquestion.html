<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
    />
    <title>Muokkaa kysymystä</title>
    
  </head>

  <body>
    <div>
      <h1>Muokkaa kysymystä</h1>
      <form th:object="${question}" method="post" th:action="@{/{surveyId}/editquestion/savequestion(surveyId=${question.survey.surveyId})}">

        <input type="hidden" th:field="*{survey.surveyId}" />
        <input type="hidden" th:field="*{questionId}" />

        <div>
          <label for="title">Kysymys:</label>
          <input type="text" id="title" name="title" th:field="*{questionText}" required />
        </div>

             <div>
          <input id="required" name="isRequired" type="radio" value="TRUE"/>
          <label for="required">Pakollinen</label>
          <input id="notRequired" name="isRequired" type="radio" value="FALSE" checked="TRUE" />
          <label for="notRequired">Ei pakollinen</label>
        </div>

        <div>
          <label for="typeSelection">Kysymyksen tyyppi:</label>
          <select id="typeSelection" name="typeSelection" th:field="*{questionType}" onchange="toggleOptions()">
            <option value="TEXT">Teksti</option>
            <option value="CHECKBOX">Valitse 1 tai useampi</option>
            <option value="RADIO">Valitse 1</option>
            <option value="SCALE">Asteikko 1-5</option>
          </select>
        </div>

       <div>
      <input type="hidden" id="priority" name="priority" th:field="*{orderNumber}" />
    </div>

        <div id="optionsContainer" style="margin-top:8px; display:none;">
          <label>Vaihtoehdot:</label>
          <div id="optionFields">
            <div th:each="opt,iterStat : *{options}">
              <div class="option-row">
                <input type="hidden" th:name="${'options[' + iterStat.index + '].optionId'}" th:value="${opt.optionId}" />
                <input type="text" th:name="${'options[' + iterStat.index + '].title'}" th:value="${opt.title}" /><!-- --><button type="button" th:if="${opt.optionId != null}" th:onclick="|location.href='@{/{surveyId}/editquestion/{questionId}/deleteoption/{optionId}(surveyId=${question.survey.surveyId},questionId=${question.questionId},optionId=${opt.optionId})}'|" class="btn btn-danger btn-sm">Poista</button><!-- -->
                <button type="button" th:if="${opt.optionId == null}" class="btn btn-danger btn-sm" onclick="event.target.parentElement.remove(); reindexOptionFields();">Poista</button>
              </div>
            </div>
          </div>
          <button type="button" onclick="addOptionField()">Uusi vaihtoehto</button>
        </div>

        <div>
          <input type="submit" value="Tallenna muutokset" />
        </div>

      </form>
    </div>
  </body>
  <script>
  // shows or hides the options container depending on selected question type
    function toggleOptions() {
      const type = document.getElementById("typeSelection").value;
      const container = document.getElementById("optionsContainer");
      if (type === 'RADIO' || type === 'CHECKBOX') {
        container.style.display = 'block';
    // adds a field if none exist
    if (document.querySelectorAll('#optionFields input[type=text]').length === 0) addOptionField();
      } else {
        container.style.display = 'none';
      }
    }

    function addOptionField() {
      const optionFields = document.getElementById('optionFields');
    // index starts at 0. length is the index for the new option.
    // (querySelector is a method that finds elements matching the CSS selector, so here we count text input fields)
      const index = optionFields.querySelectorAll('input[type=text]').length;

      const row = document.createElement('div');
      row.className = 'option-row';

      // create hidden input for optionId for server to keep track of options (if need to create new option, delete option, etc)
      const hiddenOptionId = document.createElement('input');
      hiddenOptionId.type = 'hidden';
      hiddenOptionId.name = 'options[' + index + '].optionId';
      hiddenOptionId.value = '';

      const optionInput = document.createElement('input');
      optionInput.type = 'text';
      optionInput.placeholder = 'Vaihtoehto ' + (index + 1);
      optionInput.name = 'options[' + index + '].title';
      optionInput.required = true;

  // delete button for the option
  const deleteButton = document.createElement('button');
  deleteButton.type = 'button';
  deleteButton.textContent = 'Poista';
  deleteButton.className = 'btn btn-danger btn-sm';
  deleteButton.onclick = function() { row.remove(); reindexOptionFields(); };

      row.appendChild(hiddenOptionId);
  row.appendChild(optionInput);
  row.appendChild(deleteButton);
      optionFields.appendChild(row);
    }

    //when DOM loads, initialise options UI
    document.addEventListener('DOMContentLoaded', function() { try { toggleOptions(); } catch(e){} });

  // reindexes option fields after deletion to keep indices continuous
    function reindexOptionFields() {
      const rows = document.querySelectorAll('#optionFields .option-row');
      rows.forEach((row, idNumber) => {
        const hiddenOptionId = row.querySelector('input[type=hidden]');
        const inputText = row.querySelector('input[type=text]');
        if (hiddenOptionId) hiddenOptionId.name = 'options[' + idNumber + '].optionId';
        if (inputText) {
          inputText.name = 'options[' + idNumber + '].title';
          inputText.placeholder = 'Vaihtoehto ' + (idNumber + 1);
        }
      });
    }
  </script>
</html>
