<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lisää kysymys</title>
  <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
    />
</head>
<body>
  <h1>Lisää kysymys</h1>

  <form th:object="${question}" method="post" th:action="@{/{surveyId}/savequestion(surveyId=${question.survey.surveyId})}">

    <input type="hidden" th:field="*{survey.surveyId}" />

    <div>
      <label for="title">Kysymys:</label><br>
      <input type="text" id="title" th:field="*{questionText}" required>
    </div>

     <div>
      <input id="required" name="isRequired" type="radio" value="TRUE">
      <label for="required">Pakollinen</label>

      <input id="notRequired" name="isRequired" type="radio" value="FALSE" checked>
      <label for="notRequired">Ei pakollinen</label>
    </div>

    <div>
      <label for="typeSelection">Kysymyksen tyyppi:</label><br>
      <select id="typeSelection" th:field="*{questionType}" onchange="toggleOptions()">
        <option value="TEXT">Teksti</option>
        <option value="CHECKBOX">Valitse 1 tai useampi</option>
        <option value="RADIO">Valitse yksi</option>
        <option value="SCALE">Asteikko 1–5</option>
      </select>
    </div>

    <div id="optionsContainer" style="display:none;">
      <label>Vaihtoehdot:</label><br>
      
      <div id="optionFields"></div>
      <button type="button" onclick="addOptionField()">Lisää vaihtoehto</button>
    </div>

    <div>
      <input type="hidden" id="priority" name="priority" th:field="*{orderNumber}" />
    </div>

    <div>
      <button type="submit">Lisää kysymys</button>
    </div>

  </form>

  <script>
    function toggleOptions() {
      const type = document.getElementById("typeSelection").value;
      const container = document.getElementById("optionsContainer");

      if (type === "RADIO" || type === "CHECKBOX") {
        container.style.display = "block";

        // adds a field if none exist
        if (document.querySelectorAll("#optionFields input").length === 0) {
          addOptionField();
        }
      } else {
        container.style.display = "none";
      }
    }

    function addOptionField() {
      const fields = document.getElementById("optionFields");
      // count only visible text inputs (one per option) to produce sequential indices
      const index = fields.querySelectorAll("input[type=text]").length;

      const row = document.createElement('div');
      row.className = 'option-row';

      const hid = document.createElement("input");
      hid.type = "hidden";
      hid.name = "options[" + index + "].optionId";
      hid.value = "";

      const optionInput = document.createElement("input");
      optionInput.type = "text";
      optionInput.placeholder = "Vaihtoehto " + (index + 1);
      optionInput.name = "options[" + index + "].title";
      optionInput.required = true;

  const btn = document.createElement('button');
  btn.type = 'button';
  btn.textContent = 'Poista';
  btn.className = 'btn btn-danger btn-sm';
  btn.onclick = function() { row.remove(); reindexOptionFields(); };

      row.appendChild(hid);
  row.appendChild(optionInput);
  row.appendChild(btn);
      fields.appendChild(row);
    }

    function reindexOptionFields() {
      const rows = document.querySelectorAll('#optionFields .option-row');
      rows.forEach((r, idx) => {
        const hid = r.querySelector('input[type=hidden]');
        const txt = r.querySelector('input[type=text]');
        if (hid) hid.name = 'options[' + idx + '].optionId';
        if (txt) {
          txt.name = 'options[' + idx + '].title';
          txt.placeholder = 'Vaihtoehto ' + (idx + 1);
        }
      });
    }
  </script>
</body>

</html>