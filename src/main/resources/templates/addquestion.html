<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lisää kysymys</title>
  <link rel="stylesheet" href="/style.css" />
</head>

<body>
  <h1>Lisää kysymys</h1>
  <form th:object="${question}" method="post"
    th:action="@{/{surveyId}/savequestion(surveyId=${question.survey.surveyId})}">
    <input type="hidden" th:field="*{survey.surveyId}" />

    <label for="title">Kysymys:</label><br>
    <input type="text" id="title" th:field="*{questionText}" required>

    <div class="optional">
      <input id="required" name="isRequired" type="radio" value="TRUE">
      <label for="required">Pakollinen</label>
    </div>
    <div class="optional">
      <input id="notRequired" name="isRequired" type="radio" value="FALSE" checked>
      <label for="notRequired">Ei pakollinen</label>
    </div>

    <label for="typeSelection">Kysymyksen tyyppi:</label><br>
    <select id="typeSelection" th:field="*{questionType}" onchange="toggleOptions()">
      <option value="TEXT">Teksti</option>
      <option value="CHECKBOX">Valitse 1 tai useampi</option>
      <option value="RADIO">Valitse yksi</option>
      <option value="SCALE">Asteikko 1–5</option>
    </select>

    <div id="optionsContainer" style="display:none;">
      <label>Vaihtoehdot:</label><br>
      <div id="optionFields"></div>
      <button class="btn btn-primary" type="button" onclick="addOptionField()">Uusi vaihtoehto</button>
    </div>

    <input type="hidden" id="priority" name="priority" th:field="*{orderNumber}" />
    <button class="btn btn-success" type="submit">Lisää kysymys</button>
  </form>

  <script>
    function toggleOptions() {
      const type = document.getElementById("typeSelection").value;
      const container = document.getElementById("optionsContainer");

      if (type === "RADIO" || type === "CHECKBOX") {
        container.style.display = "block";

        // adds a field if none exist
        if (document.querySelectorAll("#optionFields input").length === 0) {
          addOptionField();
        }
      } else {
        container.style.display = "none";
      }
    }

    function addOptionField() {
      const optionFields = document.getElementById("optionFields");
      // index starts at 0. length is the index for the new option.
      // (querySelector is a method that finds elements matching the CSS selector, so here we count text input fields)
      const index = optionFields.querySelectorAll("input[type=text]").length;

      const row = document.createElement('div');
      row.className = 'option-row';

      // create hidden input for optionId for server to keep track of options (if need to create new option, delete option, etc)
      const hiddenOptionId = document.createElement("input");
      hiddenOptionId.type = "hidden";
      hiddenOptionId.name = "options[" + index + "].optionId";
      hiddenOptionId.value = "";

      const optionInput = document.createElement("input");
      optionInput.type = "text";
      optionInput.placeholder = "Vaihtoehto " + (index + 1);
      optionInput.name = "options[" + index + "].title";
      optionInput.required = true;

      // delete button for the option
      const deleteButton = document.createElement('button');
      deleteButton.type = 'button';
      deleteButton.textContent = 'Poista';
      deleteButton.className = 'btn btn-danger btn-sm';
      deleteButton.onclick = function () { row.remove(); reindexOptionFields(); };

      // append elements to the row div
      row.appendChild(hiddenOptionId);
      row.appendChild(optionInput);
      row.appendChild(deleteButton);
      // add all of the above to the optionFields container
      optionFields.appendChild(row);
    }

    // reindexes option fields after deletion to keep indices continuous
    function reindexOptionFields() {
      const rows = document.querySelectorAll('#optionFields .option-row');
      rows.forEach((row, idNumber) => {
        const hiddenOptionId = row.querySelector('input[type=hidden]');
        const inputText = row.querySelector('input[type=text]');
        if (hiddenOptionId) hiddenOptionId.name = 'options[' + idNumber + '].optionId';
        if (inputText) {
          inputText.name = 'options[' + idNumber + '].title';
          inputText.placeholder = 'Vaihtoehto ' + (idNumber + 1);
        }
      });
    }
  </script>
</body>

</html>